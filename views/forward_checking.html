<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√¥ ph·ªèng Forward Checking CSP - 8-Puzzle (R√†ng bu·ªôc goal)</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; display: flex; gap: 20px; }
        .puzzle-container, .info-panel {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1;
        }
        .constraint-box {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            border-radius: 6px;
            padding: 12px 18px;
            margin-bottom: 18px;
            color: #15417e;
        }
        .constraint-box ul { margin: 8px 0 0 18px; }
        .puzzle-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 240px;
            margin: 20px auto;
        }
        .puzzle-cell-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 6px 0 2px 0;
            min-height: 90px;
        }
        .puzzle-select { width: 60px; height: 60px; font-size: 24px; text-align: center; border-radius: 4px; border: 2px solid #4a90e2; background: #fff; }
        .domain-cell { font-size: 13px; color: #1976d2; text-align: center; margin-top: 4px; min-height: 18px; }
        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { padding: 10px 20px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .step-list { margin-top: 20px; max-height: 250px; overflow-y: auto; }
        .step-item { padding: 10px; border-bottom: 1px solid #eee; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .visited-section { margin-top: 20px; }
        .visited-title { font-weight: bold; margin-bottom: 8px; }
        .visited-list { display: flex; flex-wrap: wrap; gap: 10px; max-height: 200px; overflow-y: auto; }
        .visited-matrix { border: 1px solid #bbb; border-radius: 4px; padding: 4px; background: #f8f9fa; }
        .visited-matrix-row { display: flex; }
        .visited-matrix-cell { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 15px; margin: 1px; background: #fff; border-radius: 2px; }
        .solution-section { margin-top: 20px; }
        .solution-title { font-weight: bold; margin-bottom: 8px; }
        .solution-path { display: flex; flex-wrap: wrap; gap: 10px; }
        .solution-matrix { border: 2px solid #388e3c; border-radius: 4px; padding: 4px; background: #e8f5e9; }
        .solution-matrix-row { display: flex; }
        .solution-matrix-cell { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 15px; margin: 1px; background: #fff; border-radius: 2px; }
        .success { color: #388e3c; font-weight: bold; }
        .backtrack { color: #d32f2f; font-weight: bold; }
        .error { color: #d32f2f; font-weight: bold; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>
    <h1>M√¥ ph·ªèng Forward Checking CSP cho 8-Puzzle (R√†ng bu·ªôc goal)</h1>
    <div class="container">
        <div class="puzzle-container">
            <h2>Nh·∫≠p tr·∫°ng th√°i 8-Puzzle (theo r√†ng bu·ªôc goal)</h2>
            <div class="constraint-box">
                <b>R√†ng bu·ªôc CSP cho tr·∫°ng th√°i goal:</b>
                <ul>
                    <li><b>Kh√¥ng tr√πng l·∫∑p:</b> M·ªói s·ªë t·ª´ 0 ƒë·∫øn 8 ch·ªâ xu·∫•t hi·ªán m·ªôt l·∫ßn.</li>
                    <li><b>R√†ng bu·ªôc li√™n ti·∫øp (theo h√†ng):</b> Hai √¥ li√™n ti·∫øp tr√™n c√πng m·ªôt h√†ng ph·∫£i ch√™nh l·ªách ƒë√∫ng 1.<br>
                        <span style="color:#1976d2;">V√≠ d·ª•: 2 - 1 = 1, 3 - 2 = 1, 5 - 4 = 1, ...</span></li>
                    <li><b>R√†ng bu·ªôc theo c·ªôt:</b> Hai √¥ c√πng c·ªôt li·ªÅn k·ªÅ ph·∫£i ch√™nh l·ªách ƒë√∫ng 3.<br>
                        <span style="color:#1976d2;">V√≠ d·ª•: 4 - 1 = 3, 5 - 2 = 3, 7 - 4 = 3, ...</span></li>
                </ul>
            </div>
            <form id="inputForm" autocomplete="off" onsubmit="return false;">
                <div class="puzzle-board" id="inputBoard"></div>
            </form>
            <div class="controls">
                <button onclick="checkValid()" id="checkBtn">Ki·ªÉm tra h·ª£p l·ªá</button>
                <button onclick="startSolving()" id="startBtn" disabled>B·∫Øt ƒë·∫ßu gi·∫£i</button>
                <button onclick="resetInput()" id="resetBtn">ƒê·∫∑t l·∫°i</button>
            </div>
            <div id="errorMsg" class="error"></div>
        </div>
        <div class="info-panel">
            <h2>Th√¥ng tin CSP & Forward Checking</h2>
            <div id="domainInfo"></div>
            <div class="step-list" id="stepList"></div>
            <div class="visited-section">
                <div class="visited-title">C√°c tr·∫°ng th√°i ƒë√£ thƒÉm:</div>
                <div class="visited-list" id="visitedList"></div>
            </div>
            <div class="solution-section" id="solutionSection" style="display:none;">
                <div class="solution-title" id="solutionTitle"></div>
                <div class="solution-path" id="solutionPath"></div>
            </div>
        </div>
    </div>
    <script>
        const N = 9;
        const goalState = [1,2,3,4,5,6,7,8,0];
        let inputState = Array(N).fill(null);
        let domains = Array(N).fill().map(() => new Set([0,1,2,3,4,5,6,7,8]));
        let currentState = null;
        let solving = false;
        let stack = [];
        let visited = new Set();
        let visitedArr = [];
        let path = [];
        let solution = null;

        function renderInputBoard() {
            const board = document.getElementById('inputBoard');
            board.innerHTML = '';
            for (let i = 0; i < N; i++) {
                const block = document.createElement('div');
                block.className = 'puzzle-cell-block';
                // select box
                const select = document.createElement('select');
                select.className = 'puzzle-select';
                select.disabled = solving;
                // T·∫°o option cho domain c√≤n l·∫°i
                const domain = Array.from(domains[i]).sort((a,b)=>a-b);
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '';
                if (inputState[i] === null) emptyOption.selected = true;
                select.appendChild(emptyOption);
                domain.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    if (inputState[i] === val) option.selected = true;
                    select.appendChild(option);
                });
                select.onchange = (e) => handleInput(i, e.target.value === '' ? null : parseInt(e.target.value));
                block.appendChild(select);
                // domain info
                const domainDiv = document.createElement('div');
                domainDiv.className = 'domain-cell';
                domainDiv.textContent = 'Mi·ªÅn: ' + domain.join(', ');
                block.appendChild(domainDiv);
                board.appendChild(block);
            }
        }

        function handleInput(idx, value) {
            inputState[idx] = value;
            updateDomains();
            renderInputBoard();
            document.getElementById('startBtn').disabled = !isInputFullValid();
        }

        function updateDomains() {
            // C·∫≠p nh·∫≠t l·∫°i domain cho t·ª´ng bi·∫øn d·ª±a tr√™n c√°c gi√° tr·ªã ƒë√£ g√°n v√† r√†ng bu·ªôc goal
            let used = new Set(inputState.filter(v => v !== null));
            for (let i = 0; i < N; i++) {
                if (inputState[i] !== null) {
                    domains[i] = new Set([inputState[i]]);
                } else {
                    // T·∫≠p gi√° tr·ªã ch∆∞a d√πng
                    let possible = [...Array(9).keys()].filter(x => !used.has(x));
                    // √Åp d·ª•ng r√†ng bu·ªôc goal
                    possible = possible.filter(val => checkGoalConstraint(i, val, inputState));
                    domains[i] = new Set(possible);
                }
            }
            showDomains();
            // N·∫øu c√≥ √¥ n√†o domain r·ªóng, b√°o l·ªói
            let hasEmpty = domains.some(d => d.size === 0);
            document.getElementById('errorMsg').textContent = hasEmpty ? 'C√≥ √¥ kh√¥ng c√≤n gi√° tr·ªã h·ª£p l·ªá do vi ph·∫°m r√†ng bu·ªôc goal!' : '';
        }

        function checkGoalConstraint(idx, val, state) {
            // R√†ng bu·ªôc: c√°c √¥ li√™n ti·∫øp (c√πng h√†ng) ch√™nh l·ªách 1, c√πng c·ªôt ch√™nh l·ªách 3, v√† kh√¥ng tr√πng l·∫∑p
            // Ki·ªÉm tra v·ªõi c√°c √¥ ƒë√£ g√°n tr∆∞·ªõc ƒë√≥
            // R√†ng bu·ªôc h√†ng ngang: idx%3 != 0 => val - state[idx-1] == 1 n·∫øu state[idx-1] != null
            if (idx % 3 !== 0 && state[idx-1] !== null) {
                if (val - state[idx-1] !== 1) return false;
            }
            // R√†ng bu·ªôc h√†ng d·ªçc: idx >= 3 => val - state[idx-3] == 3 n·∫øu state[idx-3] != null
            if (idx >= 3 && state[idx-3] !== null) {
                if (val - state[idx-3] !== 3) return false;
            }
            // R√†ng bu·ªôc ng∆∞·ª£c l·∫°i: n·∫øu √¥ sau ƒë√£ g√°n, ki·ªÉm tra val v·ªõi √¥ sau
            if (idx % 3 !== 2 && state[idx+1] !== null) {
                if (state[idx+1] - val !== 1) return false;
            }
            if (idx < 6 && state[idx+3] !== null) {
                if (state[idx+3] - val !== 3) return false;
            }
            return true;
        }

        function isInputFullValid() {
            // ƒê·ªß 9 gi√° tr·ªã, kh√¥ng tr√πng, ƒë·ªß 0-8, v√† th·ªèa m√£n r√†ng bu·ªôc goal
            const vals = inputState.filter(v => v !== null);
            if (vals.length !== 9) return false;
            const set = new Set(vals);
            for (let i = 0; i < 9; i++) if (!set.has(i)) return false;
            // Ki·ªÉm tra r√†ng bu·ªôc goal cho to√†n b·ªô
            for (let i = 0; i < 9; i++) {
                if (!checkGoalConstraint(i, inputState[i], inputState)) return false;
            }
            return true;
        }

        function checkValid() {
            updateDomains();
            renderInputBoard();
            if (isInputFullValid()) {
                addStep('<span class="success">Tr·∫°ng th√°i h·ª£p l·ªá! B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu gi·∫£i.</span>', 'success');
                document.getElementById('startBtn').disabled = false;
            } else {
                addStep('<span class="backtrack">Tr·∫°ng th√°i ch∆∞a h·ª£p l·ªá ho·∫∑c c√≤n thi·∫øu gi√° tr·ªã!</span>', 'backtrack');
                document.getElementById('startBtn').disabled = true;
            }
        }

        function resetInput() {
            inputState = Array(N).fill(null);
            domains = Array(N).fill().map(() => new Set([0,1,2,3,4,5,6,7,8]));
            solving = false;
            stack = [];
            visited = new Set();
            visitedArr = [];
            path = [];
            solution = null;
            renderInputBoard();
            resetInfo();
            document.getElementById('errorMsg').textContent = '';
        }

        function showDomains() {
            let html = '';
            for (let i = 0; i < N; i++) {
                html += `<div>√î ${i}: {${Array.from(domains[i]).sort().join(', ')}}</div>`;
            }
            document.getElementById('domainInfo').innerHTML = html;
        }

        function addStep(text, type = '') {
            const stepList = document.getElementById('stepList');
            const div = document.createElement('div');
            div.className = 'step-item' + (type ? ' ' + type : '');
            div.innerHTML = text;
            stepList.insertBefore(div, stepList.firstChild);
        }

        function renderVisited() {
            const visitedList = document.getElementById('visitedList');
            visitedList.innerHTML = '';
            visitedArr.forEach(stateStr => {
                const state = stateStr.split(',').map(Number);
                const matrix = document.createElement('div');
                matrix.className = 'visited-matrix';
                for (let i = 0; i < 3; i++) {
                    const row = document.createElement('div');
                    row.className = 'visited-matrix-row';
                    for (let j = 0; j < 3; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'visited-matrix-cell';
                        const v = state[i*3+j];
                        cell.textContent = v === 0 ? '_' : v;
                        row.appendChild(cell);
                    }
                    matrix.appendChild(row);
                }
                visitedList.appendChild(matrix);
            });
        }

        function renderSolutionPath(pathArr) {
            const section = document.getElementById('solutionSection');
            const title = document.getElementById('solutionTitle');
            const pathDiv = document.getElementById('solutionPath');
            section.style.display = 'block';
            pathDiv.innerHTML = '';
            title.textContent = `ƒê∆∞·ªùng ƒëi t·ªõi l·ªùi gi·∫£i (${pathArr.length-1} b∆∞·ªõc):`;
            pathArr.forEach(state => {
                const matrix = document.createElement('div');
                matrix.className = 'solution-matrix';
                for (let i = 0; i < 3; i++) {
                    const row = document.createElement('div');
                    row.className = 'solution-matrix-row';
                    for (let j = 0; j < 3; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'solution-matrix-cell';
                        const v = state[i*3+j];
                        cell.textContent = v === 0 ? '_' : v;
                        row.appendChild(cell);
                    }
                    matrix.appendChild(row);
                }
                pathDiv.appendChild(matrix);
            });
        }

        function resetInfo() {
            document.getElementById('domainInfo').innerHTML = '';
            document.getElementById('stepList').innerHTML = '';
            document.getElementById('visitedList').innerHTML = '';
            document.getElementById('solutionSection').style.display = 'none';
            document.getElementById('startBtn').disabled = true;
        }

        // --- Gi·∫£i b·∫±ng Forward Checking nh∆∞ c≈©, d√πng inputState l√†m tr·∫°ng th√°i ƒë·∫ßu ---
        function startSolving() {
            if (!isInputFullValid()) return;
            solving = true;
            currentState = [...inputState];
            stack = [];
            visited = new Set();
            visitedArr = [];
            path = [];
            solution = null;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('resetBtn').disabled = true;
            document.querySelectorAll('.puzzle-select').forEach(e => e.disabled = true);
            visited.add(currentState.join(','));
            visitedArr.push(currentState.join(','));
            stack.push({ state: [...currentState], path: [], domains: getValidMoves(currentState) });
            showDomains();
            renderVisited();
            addStep('B·∫Øt ƒë·∫ßu gi·∫£i b·∫±ng Forward Checking + Backtracking.');
            document.getElementById('nextBtn').disabled = false;
        }

        function getValidMoves(state) {
            const empty = state.indexOf(0);
            const moves = [];
            const row = Math.floor(empty / 3);
            const col = empty % 3;
            if (row > 0) moves.push(empty - 3);
            if (row < 2) moves.push(empty + 3);
            if (col > 0) moves.push(empty - 1);
            if (col < 2) moves.push(empty + 1);
            return moves;
        }

        function nextStep() {
            if (!solving || stack.length === 0) {
                addStep('<span class="backtrack">Kh√¥ng t√¨m th·∫•y l·ªùi gi·∫£i!</span>', 'backtrack');
                document.getElementById('nextBtn').disabled = true;
                document.getElementById('solutionSection').style.display = 'block';
                document.getElementById('solutionTitle').textContent = 'Kh√¥ng t√¨m th·∫•y l·ªùi gi·∫£i.';
                document.getElementById('solutionPath').innerHTML = '';
                return;
            }
            let node = stack.pop();
            currentState = [...node.state];
            path = node.path;
            renderInputBoard();
            showDomains();
            renderVisited();

            // ƒê√£ ƒë·∫°t tr·∫°ng th√°i ƒë√≠ch
            if (currentState.join(',') === goalState.join(',')) {
                addStep(`<span class="success">üéâ ƒê√£ t√¨m th·∫•y l·ªùi gi·∫£i! S·ªë b∆∞·ªõc: ${path.length}</span>`, 'success');
                document.getElementById('nextBtn').disabled = true;
                solving = false;
                // Hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi l·ªùi gi·∫£i
                let solutionPath = [[...goalState]];
                if (path.length > 0) {
                    let tempState = [...goalState];
                    solutionPath = [[...goalState]];
                    for (let i = path.length - 1; i >= 0; i--) {
                        const move = path[i];
                        const empty = tempState.indexOf(0);
                        [tempState[empty], tempState[move]] = [tempState[move], tempState[empty]];
                        solutionPath.unshift([...tempState]);
                    }
                }
                renderSolutionPath(solutionPath.reverse());
                return;
            }

            // N·∫øu c√≤n mi·ªÅn gi√° tr·ªã (b∆∞·ªõc ƒëi h·ª£p l·ªá)
            if (node.domains.length > 0) {
                // Ch·ªçn m·ªôt b∆∞·ªõc ƒëi (theo th·ª© t·ª±)
                const move = node.domains.shift();
                // ƒê·∫©y l·∫°i node hi·ªán t·∫°i v·ªõi mi·ªÅn gi√° tr·ªã ƒë√£ lo·∫°i b·ªè b∆∞·ªõc v·ª´a ch·ªçn
                stack.push({ state: [...currentState], path: [...path], domains: [...node.domains] });
                // Sinh tr·∫°ng th√°i m·ªõi
                const newState = [...currentState];
                const empty = newState.indexOf(0);
                [newState[empty], newState[move]] = [newState[move], newState[empty]];
                // N·∫øu ch∆∞a thƒÉm tr·∫°ng th√°i n√†y th√¨ ti·∫øp t·ª•c
                if (!visited.has(newState.join(','))) {
                    visited.add(newState.join(','));
                    visitedArr.push(newState.join(','));
                    const newDomains = getValidMoves(newState);
                    stack.push({ state: newState, path: [...path, move], domains: newDomains });
                    addStep(`G√°n: di chuy·ªÉn s·ªë ${currentState[move]} sang √¥ tr·ªëng.`, '');
                } else {
                    addStep(`B·ªè qua tr·∫°ng th√°i ƒë√£ thƒÉm.`, 'backtrack');
                }
            } else {
                // Kh√¥ng c√≤n mi·ªÅn gi√° tr·ªã, backtrack
                addStep(`<span class="backtrack">Backtrack: Kh√¥ng c√≤n mi·ªÅn gi√° tr·ªã h·ª£p l·ªá, quay lui.</span>`, 'backtrack');
            }
        }

        window.onload = function() {
            renderInputBoard();
            resetInfo();
            document.getElementById('nextBtn').disabled = true;
        };
    </script>
    <div class="controls" style="justify-content:center; margin-top:30px;">
        <button onclick="nextStep()" id="nextBtn" disabled>B∆∞·ªõc ti·∫øp theo</button>
    </div>
</body>
</html>
