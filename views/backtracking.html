<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√¥ ph·ªèng Backtracking CSP - 8-Puzzle</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; }
        .puzzle-container, .info-panel {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1;
        }
        .puzzle-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 300px; height: 300px; margin: 20px auto; }
        .puzzle-cell {
            background: #4a90e2; color: white; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;
        }
        .puzzle-cell.empty { background: #e9ecef; color: #4a90e2; }
        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { padding: 10px 20px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .step-list { margin-top: 20px; max-height: 250px; overflow-y: auto; }
        .step-item { padding: 10px; border-bottom: 1px solid #eee; }
        .highlight { background: #fff3cd; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .domain-list { margin: 10px 0; }
        .domain-list span { display: inline-block; margin-right: 8px; }
        .backtrack { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .visited-section { margin-top: 20px; }
        .visited-title { font-weight: bold; margin-bottom: 8px; }
        .visited-list { display: flex; flex-wrap: wrap; gap: 10px; max-height: 200px; overflow-y: auto; }
        .visited-matrix { border: 1px solid #bbb; border-radius: 4px; padding: 4px; background: #f8f9fa; }
        .visited-matrix-row { display: flex; }
        .visited-matrix-cell { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 15px; margin: 1px; background: #fff; border-radius: 2px; }
        .solution-section { margin-top: 20px; }
        .solution-title { font-weight: bold; margin-bottom: 8px; }
        .solution-path { display: flex; flex-wrap: wrap; gap: 10px; }
        .solution-matrix { border: 2px solid #388e3c; border-radius: 4px; padding: 4px; background: #e8f5e9; }
        .solution-matrix-row { display: flex; }
        .solution-matrix-cell { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 15px; margin: 1px; background: #fff; border-radius: 2px; }
    </style>
</head>
<body>
    <h1>M√¥ ph·ªèng Backtracking CSP cho 8-Puzzle</h1>
    <div class="container">
        <div class="puzzle-container">
            <h2>B·∫£ng 8-Puzzle</h2>
            <div class="puzzle-board" id="puzzleBoard"></div>
            <div class="controls">
                <button onclick="shufflePuzzle()" id="shuffleBtn">T·∫°o tr·∫°ng th√°i ng·∫´u nhi√™n</button>
                <button onclick="startSolving()" id="startBtn">B·∫Øt ƒë·∫ßu gi·∫£i</button>
                <button onclick="nextStep()" id="nextBtn" disabled>B∆∞·ªõc ti·∫øp theo</button>
                <button onclick="resetPuzzle()" id="resetBtn">ƒê·∫∑t l·∫°i</button>
            </div>
        </div>
        <div class="info-panel">
            <h2>Qu√° tr√¨nh gi·∫£i Backtracking CSP</h2>
            <div id="domainInfo"></div>
            <div class="step-list" id="stepList"></div>
            <div class="visited-section">
                <div class="visited-title">C√°c tr·∫°ng th√°i ƒë√£ thƒÉm:</div>
                <div class="visited-list" id="visitedList"></div>
            </div>
            <div class="solution-section" id="solutionSection" style="display:none;">
                <div class="solution-title" id="solutionTitle"></div>
                <div class="solution-path" id="solutionPath"></div>
            </div>
        </div>
    </div>
    <script>
        const goalState = [1,2,3,4,5,6,7,8,0];
        let currentState = [...goalState];
        let solving = false;
        let stack = [];
        let visited = new Set();
        let visitedArr = [];
        let path = [];
        let solution = null;

        function renderPuzzle(state = currentState) {
            const board = document.getElementById('puzzleBoard');
            board.innerHTML = '';
            state.forEach((value, idx) => {
                const cell = document.createElement('div');
                cell.className = `puzzle-cell${value === 0 ? ' empty' : ''}`;
                cell.textContent = value === 0 ? '' : value;
                board.appendChild(cell);
            });
        }

        function shufflePuzzle() {
            do {
                currentState = [...goalState];
                for (let i = currentState.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentState[i], currentState[j]] = [currentState[j], currentState[i]];
                }
            } while (!isSolvable(currentState));
            renderPuzzle();
            resetInfo();
            addStep('ƒê√£ t·∫°o tr·∫°ng th√°i ng·∫´u nhi√™n m·ªõi.');
        }

        function isSolvable(state) {
            let inv = 0;
            const arr = state.filter(x => x !== 0);
            for (let i = 0; i < arr.length - 1; i++)
                for (let j = i + 1; j < arr.length; j++)
                    if (arr[i] > arr[j]) inv++;
            return inv % 2 === 0;
        }

        function resetPuzzle() {
            currentState = [...goalState];
            solving = false;
            stack = [];
            visited = new Set();
            visitedArr = [];
            path = [];
            solution = null;
            renderPuzzle();
            resetInfo();
            addStep('ƒê√£ ƒë·∫∑t l·∫°i puzzle v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu.');
        }

        function resetInfo() {
            document.getElementById('domainInfo').innerHTML = '';
            document.getElementById('stepList').innerHTML = '';
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('shuffleBtn').disabled = false;
            document.getElementById('visitedList').innerHTML = '';
            document.getElementById('solutionSection').style.display = 'none';
        }

        function addStep(text, type = '') {
            const stepList = document.getElementById('stepList');
            const div = document.createElement('div');
            div.className = 'step-item' + (type ? ' ' + type : '');
            div.innerHTML = text;
            stepList.insertBefore(div, stepList.firstChild);
        }

        function getValidMoves(state) {
            const empty = state.indexOf(0);
            const moves = [];
            const row = Math.floor(empty / 3);
            const col = empty % 3;
            if (row > 0) moves.push(empty - 3);
            if (row < 2) moves.push(empty + 3);
            if (col > 0) moves.push(empty - 1);
            if (col < 2) moves.push(empty + 1);
            return moves;
        }

        function showDomains(state) {
            const empty = state.indexOf(0);
            const moves = getValidMoves(state);
            let html = `<div class='domain-list'><b>C√°c b∆∞·ªõc ƒëi h·ª£p l·ªá cho √¥ tr·ªëng [${empty}]:</b> `;
            html += moves.map(m => state[m]).join(', ');
            html += '</div>';
            document.getElementById('domainInfo').innerHTML = html;
        }

        function renderVisited() {
            const visitedList = document.getElementById('visitedList');
            visitedList.innerHTML = '';
            visitedArr.forEach(stateStr => {
                const state = stateStr.split(',').map(Number);
                const matrix = document.createElement('div');
                matrix.className = 'visited-matrix';
                for (let i = 0; i < 3; i++) {
                    const row = document.createElement('div');
                    row.className = 'visited-matrix-row';
                    for (let j = 0; j < 3; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'visited-matrix-cell';
                        const v = state[i*3+j];
                        cell.textContent = v === 0 ? '_' : v;
                        row.appendChild(cell);
                    }
                    matrix.appendChild(row);
                }
                visitedList.appendChild(matrix);
            });
        }

        function renderSolutionPath(pathArr) {
            const section = document.getElementById('solutionSection');
            const title = document.getElementById('solutionTitle');
            const pathDiv = document.getElementById('solutionPath');
            section.style.display = 'block';
            pathDiv.innerHTML = '';
            title.textContent = `ƒê∆∞·ªùng ƒëi t·ªõi l·ªùi gi·∫£i (${pathArr.length-1} b∆∞·ªõc):`;
            pathArr.forEach(state => {
                const matrix = document.createElement('div');
                matrix.className = 'solution-matrix';
                for (let i = 0; i < 3; i++) {
                    const row = document.createElement('div');
                    row.className = 'solution-matrix-row';
                    for (let j = 0; j < 3; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'solution-matrix-cell';
                        const v = state[i*3+j];
                        cell.textContent = v === 0 ? '_' : v;
                        row.appendChild(cell);
                    }
                    matrix.appendChild(row);
                }
                pathDiv.appendChild(matrix);
            });
        }

        function startSolving() {
            solving = true;
            stack = [];
            visited = new Set();
            visitedArr = [];
            path = [];
            solution = null;
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('shuffleBtn').disabled = true;
            visited.add(currentState.join(','));
            visitedArr.push(currentState.join(','));
            stack.push({ state: [...currentState], path: [], moves: getValidMoves(currentState) });
            showDomains(currentState);
            renderVisited();
            addStep('B·∫Øt ƒë·∫ßu gi·∫£i b·∫±ng Backtracking CSP.');
        }

        function nextStep() {
            if (!solving || stack.length === 0) {
                addStep('<span class="backtrack">Kh√¥ng t√¨m th·∫•y l·ªùi gi·∫£i!</span>', 'backtrack');
                document.getElementById('nextBtn').disabled = true;
                document.getElementById('solutionSection').style.display = 'block';
                document.getElementById('solutionTitle').textContent = 'Kh√¥ng t√¨m th·∫•y l·ªùi gi·∫£i.';
                document.getElementById('solutionPath').innerHTML = '';
                return;
            }
            let node = stack.pop();
            currentState = [...node.state];
            path = node.path;
            renderPuzzle();
            showDomains(currentState);
            renderVisited();

            // ƒê√£ ƒë·∫°t tr·∫°ng th√°i ƒë√≠ch
            if (currentState.join(',') === goalState.join(',')) {
                addStep(`<span class="success">üéâ ƒê√£ t√¨m th·∫•y l·ªùi gi·∫£i! S·ªë b∆∞·ªõc: ${path.length}</span>`, 'success');
                document.getElementById('nextBtn').disabled = true;
                solving = false;
                // Hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi l·ªùi gi·∫£i
                let solutionPath = [[...goalState]];
                if (path.length > 0) {
                    let tempState = [...goalState];
                    solutionPath = [[...goalState]];
                    for (let i = path.length - 1; i >= 0; i--) {
                        const move = path[i];
                        const empty = tempState.indexOf(0);
                        [tempState[empty], tempState[move]] = [tempState[move], tempState[empty]];
                        solutionPath.unshift([...tempState]);
                    }
                }
                renderSolutionPath(solutionPath.reverse());
                return;
            }

            // N·∫øu c√≤n b∆∞·ªõc ƒëi h·ª£p l·ªá
            if (node.moves.length > 0) {
                // Ch·ªçn m·ªôt b∆∞·ªõc ƒëi (theo th·ª© t·ª±)
                const move = node.moves.shift();
                // ƒê·∫©y l·∫°i node hi·ªán t·∫°i v·ªõi c√°c b∆∞·ªõc c√≤n l·∫°i
                stack.push({ state: [...currentState], path: [...path], moves: [...node.moves] });
                // Sinh tr·∫°ng th√°i m·ªõi
                const newState = [...currentState];
                const empty = newState.indexOf(0);
                [newState[empty], newState[move]] = [newState[move], newState[empty]];
                // N·∫øu ch∆∞a thƒÉm tr·∫°ng th√°i n√†y th√¨ ti·∫øp t·ª•c
                if (!visited.has(newState.join(','))) {
                    visited.add(newState.join(','));
                    visitedArr.push(newState.join(','));
                    const newMoves = getValidMoves(newState);
                    stack.push({ state: newState, path: [...path, move], moves: newMoves });
                    addStep(`G√°n: di chuy·ªÉn s·ªë ${currentState[move]} sang √¥ tr·ªëng.`, '');
                } else {
                    addStep(`B·ªè qua tr·∫°ng th√°i ƒë√£ thƒÉm.`, 'backtrack');
                }
            } else {
                // Kh√¥ng c√≤n b∆∞·ªõc ƒëi h·ª£p l·ªá, backtrack
                addStep(`<span class="backtrack">Backtrack: Kh√¥ng c√≤n b∆∞·ªõc ƒëi h·ª£p l·ªá, quay lui.</span>`, 'backtrack');
            }
        }

        window.onload = function() {
            renderPuzzle();
            resetInfo();
        };
    </script>
</body>
</html>
